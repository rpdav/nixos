# NixOS Config

This is my NixOS configuration. I'm a newbie to Nix and this is my first public repo. Caveat emptor.

## Repo Tree

```
.
├── home            home-manager configurations
├── system           system (NixOS) configurations
├── lib             custom library to make import paths cleaner (credit to EmergentMind) 
├── modules         custom nixos and home-manager modules
├── nix-secrets     contains example secrets files from my private secrets repo
├── services        selfhosted service configs
├── themes          wallpapers and matching base16 schemes
├── vars            contains custom options for user- and system-specific config. See the Custom Options section of this readme.
├── flake.lock      automatically generated by NixOS containing pinned versions of inputs in `flake.nix`
├── flake.nix       flake definition
├── justfile        config file for just. Several commands were borrowed from Ryan Lin's config
└── uptix.lock		like flake.lock but for docker image hashes. See readme in the services directory
```

## Features

* Flakes: better control of depencies and reproducibility
* Impermanence: auto-delete cruft to keep that "new computer smell"
* Home-manager: manage user applications and configuration across multiple systems
* Multi-host friendly: config structure is designed that it's easy to add new users/hosts and share as much common config as possible
* Sops-nix: for secrets management
* Disko: declarative disk partitioning
* Lanzaboote: secure boot
* Stylix: system-wide theming
* Hyprland: like building a desktop environment with legos
* Nixvirt: declarative VM management

## Structure

The structure of this repo is designed to make it easy to quickly add new users and hosts while also sharing as much common configuration as possible for each user/host. If you're starting out with a single host and user, this may seem overkill but if you think you might ever branch out in the future, it's much easier to add more with this sort of structure in place.

Below gives some examples of what configuration would go where using this structure:

| Location                       | Usage                                                        |
| ------------------------------ | ------------------------------------------------------------ |
| system/hosts/fw13              | Nixos configuration specific to host fw13 (think hostname, host-specific hardware, `hardware-configuration.nix`). This is the only module called by `flake.nix`. This module imports all other nixos modules used by this host. |
| system/common/core             | Nixos configuration used on all systems - this directory is imported in its entirety on all systems |
| system/common/optional         | Nixos configuration on some (but not all) systems - modules in this directory are imported on a case-by-case basis per host |
| system/common/users/ryan       | Nixos configuration for user ryan (on multiple systems). This would include user definition, groups,  password hash, and ssh public keys. This file also includes the home-manager nixos module which points to home/`username`/`hostname`.nix for the actual home-manager configuration. |
| home/ryan/fw13.nix             | Home-manager configuration specific to user ryan on host fw13. This module |
| home/common/core               | Home-manager configuration used by all users                 |
| home/common/optional           | Home-manager configuration used by some (but not all) users. Or by all users but only on certain hosts. |
| services/common                | Self-hosted services for all systems that run services. Currently just my reverse proxy `swag` |
| services/nas                   | Self-hosted services run on host nas                         |

Bringing up a new host or user is as simple as:
1. Copying a similar host- or user-specific config
2. Making any needed host-specific changes (e.g. updating usernames, hostnames, device tweaks)
3. Choosing which optional modules will be imported for the new host or user

## Custom options

Several custom options are defined in `vars/default.nix`. These are used to set several system-, user-, or service-related options in each system's or user's config files. This allows shared modules to be tailored to each system/user without rewriting the whole module. Here are a few use cases:
* Use a common `disko` config but vary the swap file size based on `systemOpts.swapSize` (or disable swap entirely with `systemOpts.swapEnable`)
* Use a common `packages.nix` to load packages on all system, but exclude gui apps for headless systems based on `systemOpts.gui` being set to false.
* Use a common `stylix.nix` module for system-wide theming, but each user can set their own `userOpts.theme`, `userOpts.cursor`, and `userOpts.font`.

## Secrets

See readme in nix-secrets directory.

## Selfhosted Services

The `services` directory contains (mostly) container-based selfhosted services. Most of these are running on my nas but a few run on vps such as a mail server. Bootstrapping a container-based service takes a bit more work than simple compose files. I've found a few tools (and have written a couple simple modules) that help speed that process up. More details in the `services` directory.

## Impermanence

[Impermanence](https://github.com/nix-community/impermanence) is a community module that is designed with the intention of deleting all of `/` during boot with the exception of `/boot`, `/nix`, and `/persist` (and optionally `/home`). Most of the contents of `/etc`, `/usr`, and `/bin` are just symlinks to `/nix/store` and these are rebuilt at boot if they don't already exist. [GrahamC's blog](https://grahamc.com/blog/erase-your-darlings/) goes into further detail about why you would want to do this.

Not everything can be fully declared in the NixOS config, so some critical files in `/etc` and `/var/lib` are symlinked or bind-mounted to files in `/persist` using the impermanence module. There is both a NixOS module and a home-manager module for dotfiles in `/home`.

### Methods of wiping `/`

The impermanence module does not include a function to wipe the non-persistent directories. This config uses btrfs subvolumes and wipes them using a script taken from the [impermanence repo](https://github.com/nix-community/impermanence?tab=readme-ov-file#btrfs-subvolumes). This has the advantage of keeping a handful of recently deleted roots as btrfs snapshots. If I forget to persist something and reboot, it can be recovered by mounting that snapshot. This method works for zfs as well but would need a different wiping script. GrahamC's blog linked above has one.

The other method is to use a tmpfs for `/`. This is simpler but uses more RAM and doesn't preserve the recently deleted root volumes.

### How to persist `/home`

 You have to decide how granular you want to be in persisting `/home`:
* You could persist all of `/home`. Cruft will accumulate in `~` and `.config` but you may be OK with that. This can be done by persisting home in the NixOS impermanence module or by having a separate subvolume for `/home` that doesn't get wiped at all.
* You could persist the main folders, like user data folders, `.config`, `.local`, and `.ssh`. This is a good middle ground.
* You could persist individual folders within `.config` and `.local`. You will have to comb through these folders and determine what you want to keep and throw away. Anything managed by home-manager should be declaratively symlinked to `/nix/store` and does not need to be persisted. Some applications spew a lot of loose files and folders in `.config` (looking at you, KDE), so this can be a bit fussy. If you have a lot application churn, you'll have to tweak this frequently. But the more you configure your system with home-manager, the less you will need to persist within `.config`.

My recommendation is to begin by persisting everything and gradually fine-tune it if you want. If something breaks, those files still exist in `/persist` and can be easily restored. If you're not sure where an application is storing its config or data, I include a `fs-diff` script which recursively lists all files in a directory, ignoring bind mounts and symlinks. By storing the output of this script in a file before and after making the change you're interested in, you can run a `diff` on those two files and see where that application is writing its change. I've found this especially useful for window manager files.

NB: If you are using the home-manager impermanence module, and intend to persist `~/.config/systemd` (or all of `~/.config`), do it through the **system** impermanence config, not home-manager. The bind mounts made by impermanence are done using systemd, which themselves live in `~/.config/systemd` for home-manager services. Home-manager will fail if you try to do this using its impermanence module. You probably don't need to persist `~/.config/systemd` itself though since its contents should be in your config.

## Hyprland

My hyprland config is pretty simple but I'm happy with how it so far. Nix and the hypr ecosystem complement each other very well. It works great with stylix too.

## Themes

Theming is handled by [Stylix](https://nix-community.github.io/stylix/), a nixos module that applies system-wide colors, fonts, icons, cursors, and wallpapers. My stylix config is defined in `system/common/core/stylix.nix`.

The `themes` directory contains subdirectories for each theme with a wallpaper, polarity file, and scheme file. These are all accessed by stylix based on the theme chosen through `userOpts.theme`. I currently have the following themes:

| Theme Name  | Base16Scheme              |
|-------------|---------------------------|
| everforest  | everforest                |
| gruvbox     | gruvbox-dark-medium       |
| latte       | catppuccin-latte          |
| mocha       | catppuccin-mocha          |
| moon        | tokyo-night-terminal-dark |
| mountain    | catppuccin-latte          |
| nord        | nord                      |
| rainbow-cat | catppuccin-mocha          |
| tokyo       | tokyo-night-terminal-dark |

[Base16Schemes](https://github.com/tinted-theming/schemes?tab=readme-ov-file) are a set of 16 coordinated colors. You can also build your own base16 scheme with stylix if you prefer. You can get scheme names and colors by running `nix build nixpkgs#base16-schemes` and browsing to `result/share/themes`.

## Virtualization
My `nas` system is also a virtualization host running a windows VM with some hardware passthrough (an NVME drive, GPU, and USB controller). I use [nixvirt](https://github.com/AshleyYakeley/NixVirt) which allows libvirt networks and domains (that is, VMs) to be configured with nix expressions. See the readme in `system/hosts/nas/win-vm` for more details.

## Initial Install
See readme files in each host's subfolder.

## Acknowledgements
* [LibrePhoenix](https://github.com/librephoenix/nixos-config) - Phoenix's videos were a big help in setting up my initial system.
* [Ryan Lin's NixOS and Flakes book](https://nixos-and-flakes.thiscute.world/) - This was probably the single most helpful resource for me in understanding flakes.
* [Emergent Mind](https://github.com/EmergentMind/nix-config) - Helpful videos on SOPS, nixos-anywhere, and yubikey configs. I modeled the structure of my config after his and have borrowed several of his modules.
* [Vim Joyer](https://github.com/vimjoyer/) - Tons of videos on setting up a NixOS system, like impermanence, secrets, stylix, gaming...the list goes on!
* [TheMaxMur's config](https://github.com/TheMaxMur/NixOS-Configuration) - Great documentation and contains a lot of features I borrowed from, like disko and lanzaboote.
* [NixOS: Everything Everywhere All At Once](https://www.youtube.com/watch?v=CwfKlX3rA6E) - This convinced me to jump down the NixOS rabbit hole in the first place.
* [DHH's Omarchy](https://github.com/basecamp/omarchy) - A beautiful, batteries-included hyprland config based on Arch. I borrowed some of his themes, keybinds, and apps for hyprland.
