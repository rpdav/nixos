# NixOS Config

This is my NixOS configuration. I'm a newbie to Nix and this is my first public repo. Caveat emptor.

## Structure

```
.
├── home            contains home-manager configurations
├── hosts           contains system (NixOS) configurations
├── themes          placeholder to build out stylix themes and wallpapers; currently just has wallpapers since I'm still building this out
├── flake.lock      automatically generated by NixOS containing pinned versions of inputs in `flake.nix`
├── flake.nix       flake definition (currently just NixOS configs)
├── justfile        config file for just. Several commands were borrowed from Ryan Lin's config
└── variables.nix   contains common system-related attributes like default usernames, architecture, and swap file size. The default values in this file can be overridden in each system's config. This lets me put more of my config in the home/common and hosts/common directories while still tailoring to each system. (NB these really aren't variables like are used in `let/in` bindings. They're actually custom options.)
```

## Features
* Flakes: better control of depencies and reproducibility
* Impermanence: keep that "new computer smell"
* Home-manager: manage user applications and configuration across multiple systems
* Multi-host friendly: config structure is designed that it's easy to add new users/hosts and share common modules
* Sops-nix: for secrets management
* Stylix: system-wide theming (WIP)
* Disko: declarative disk partitioning (WIP)

## Secrets

I manage my secrets in a private nix-secrets repo defined in `flake.nix`. Even though contents are encrypted, I prefer they stay [reasonably private](https://github.com/getsops/sops?tab=readme-ov-file#weak-aes-cryptography). It contains 2 sources of secrets:

1. `secrets.yaml`: this is a sops-nix archive which is encrypted at rest. It is imported through the flake input `mysecrets` and decrypted at runtime.
2. `secrets.json`: this file used to live in this repo and be encrypted through git-crypt (cleartext on disk, but encrypted when pushed to github/gitea). Since git-crypt won't work through a flake input, this is file now in cleartext in the private repo too. I eventually want to replace this with secrets defined directly in a flake.

`sops-nix` is the preferred method since it does not leak world-readable secrets to `/nix/store`. But some modules do not support the `sops-nix` method of deploying secrets, which is `"cat ${config.sops.secrets.secretname.path}"`. In particular this does not work for `accounts.email.accounts.<name>.address` home-manager option which expects an input in the format of `name@domain.tld` - [example](https://discourse.nixos.org/t/is-there-a-way-to-configure-email-accounts-without-putting-personal-info-in-cleartext-home-manager/41216/2). It also does not work for endpoints in wireguard configs. So some secrets are imported directly from the json file where sops-nix does not work. These less-critical secrets are world-readable in `/nix/store` but I'm more concerned about keeping them off of my public repo (like email addresses).

## Impermanence

[Impermanence](https://github.com/nix-community/impermanence) is a community module that is designed with the intention of deleting all of `/` during boot with the exception of `/boot`, `/nix`, and `/persist` (and optionally `/home`).  [GrahamC's blog](https://grahamc.com/blog/erase-your-darlings/) goes into detail about why you would want to do this.

Not everything can be fully declared in the NixOS config, so some critical files in `/etc` and `/var` are symlinked to files in `/persist` using the impermanence module. There is both a NixOS module and a home-manager module for dotfiles in `/home`.

### Methods of wiping `/`

The impermanence module does not include a function to wipe the non-persistent directories. This config uses btrfs subvolumes and wipes them using a script taken from the [impermanence repo](https://github.com/nix-community/impermanence?tab=readme-ov-file#btrfs-subvolumes). This has the advantage of keeping a handful of recently deleted roots as btrfs snapshots. If I forget to persist something and reboot, it can be recovered by mounting that snapshot. This method works for zfs as well but would need a different wiping script. GrahamC's blog linked above has one.

The other method is to use a tmpfs for `/`. This is simpler but uses more RAM and doesn't preserve the recently deleted root volumes.

### How to persist `/home`

 You have to decide how granular you want to be in persisting `/home`:
* You could persist all of `/home`. Cruft will accumulate in `~` and `.config` but you may be OK with that. This can be done by persisting home in the NixOS impermanence module or by having a separate subvolume for `/home` if using the btrfs/zfs method.
* You could persist the main folders, like data folders, `.config`, `.local`, and `.ssh`. This is a good middle ground.
* You could persist individual folders within `.config` and `.local`. You will have to comb through these folders and determine what you want to keep and throw away. Anything managed by home-manager should be symlinked to `/nix/store` and does not need to be persisted. Some applications spew a lot of loose files and folders in `.config` (looking at you, KDE), so this can be a bit fussy. If you have a lot application churn, you'll have to tweak this frequently.

My recommendation is to begin by persisting everything and gradually fine-tune it if you want. If something breaks, those files still exist in `/persist` and can be easily restored. If you're not sure where an application is storing its config or data, I include a `fs-diff` script which recursively lists all files in a directory, ignoring bind mounts and symlinks. By storing the output of this script in a file before and after making the change you're interested in, you can run `diff` on those two files and see where that application is writing its change. I've found this especially useful for window managers.

NB: If you are using the home-manager impermanence module, and intend to persist `~/.config/systemd` (or all of `~/.config`) through the **system** impermanence config, not home-manager. The bind mounts made by impermanence are done using systemd, which themselves live in `~/.config/systemd` for home-manager services. Home-manager will fail if you try to do this using its impermanence module. You probably don't need to persist `~/.config/systemd` though since its contents should be in your config.

## Initial Install
See readme files in each host's subfolder.

## Acknowledgements
* [LibrePhoenix](https://github.com/librephoenix/nixos-config) - Phoenix's videos were a big help in setting up my initial system.
* [Ryan Lin's NixOS and Flakes book](https://nixos-and-flakes.thiscute.world/) - This was probably the single most helpful resource for me on understanding flakes.
* [Emergent Mind](https://github.com/EmergentMind/nix-config) - Helpful videos on SOPS and nixos-anywhere. I modeled the structure of my config after his.
* [Vim Joyer](https://github.com/vimjoyer/) - Tons of videos on setting up a NixOS system, like impermanence, secrets, stylix, gaming...the list goes on!
* [TheMaxMur's config](https://github.com/TheMaxMur/NixOS-Configuration) - Great documentation and contains a lot of features I'd like to implement like disko and eventually lanzaboot.
* [NixOS: Everything Everywhere All At Once](https://www.youtube.com/watch?v=CwfKlX3rA6E) - This convinced me to jump down the NixOS rabbit hole.

## TODOs
* move secrets.json in nix-secrets repo to a flake
* Automate garbage collection
* Automate backups (this is supposed to be daily and automatic but isn't working)
* Implement EmergentMind's relativetoroot feature
* Try out cosmic and/or hyprland
* Add new hosts to config:
  * New laptop (Framework 13)
  * Switch over docker host/NAS to NixOS (currently Unraid)
  * Switch over vps to Nixos (currently Ubuntu)
