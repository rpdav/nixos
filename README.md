# NixOS Config

This is my NixOS configuration. I'm a newbie to Nix and this is my first public repo. Caveat emptor.

## Structure

```
.
├── home            home-manager configurations
├── hosts           system (NixOS) configurations
├── lib             custom library to make import paths cleaner (credit to EmergentMind) 
├── modules         custom nixos and home-manager modules
├── nix-secrets     contains example secrets files from my private secrets repo
├── services        selfhosted service configs
├── themes          wallpapers and matching base16 schemes
├── vars            contains common system-related attributes like default usernames, architecture, and swap file size. The default values in this file can be overridden in each system's config. This lets me put more of my config in the home/common and hosts/common directories while still tailoring to each system.
                    (NB these really aren't variables like are used in `let/in` bindings. They're actually custom options.)
├── flake.lock      automatically generated by NixOS containing pinned versions of inputs in `flake.nix`
├── flake.nix       flake definition (currently just NixOS configs)
├── justfile        config file for just. Several commands were borrowed from Ryan Lin's config
```

## Features
* Flakes: better control of depencies and reproducibility
* Impermanence: auto-delete cruft to keep that "new computer smell"
* Home-manager: manage user applications and configuration across multiple systems
* Multi-host friendly: config structure is designed that it's easy to add new users/hosts and share as much common config as possible
* Sops-nix: for secrets management
* Disko: declarative disk partitioning
* Lanzaboote: secure boot
* Stylix: system-wide theming
* Hyprland: like building a desktop environment with legos

## Secrets
See readme in nix-secrets directory.

## Selfhosted Services
The `services` directory contains (mostly) container-based selfhosted services. Most of these are running on my nas but a few run on vps such as a mail server. Bootstrapping a container-based service takes a bit more work than simple compose files. I've found a few tools (and have written a couple simple modules) that help speed that process up. More details in the `services` directory.

## Impermanence

[Impermanence](https://github.com/nix-community/impermanence) is a community module that is designed with the intention of deleting all of `/` during boot with the exception of `/boot`, `/nix`, and `/persist` (and optionally `/home`).  [GrahamC's blog](https://grahamc.com/blog/erase-your-darlings/) goes into detail about why you would want to do this.

Not everything can be fully declared in the NixOS config, so some critical files in `/etc` and `/var` are symlinked or bind-mounted to files in `/persist` using the impermanence module. There is both a NixOS module and a home-manager module for dotfiles in `/home`.

### Methods of wiping `/`

The impermanence module does not include a function to wipe the non-persistent directories. This config uses btrfs subvolumes and wipes them using a script taken from the [impermanence repo](https://github.com/nix-community/impermanence?tab=readme-ov-file#btrfs-subvolumes). This has the advantage of keeping a handful of recently deleted roots as btrfs snapshots. If I forget to persist something and reboot, it can be recovered by mounting that snapshot. This method works for zfs as well but would need a different wiping script. GrahamC's blog linked above has one.

The other method is to use a tmpfs for `/`. This is simpler but uses more RAM and doesn't preserve the recently deleted root volumes.

### How to persist `/home`

 You have to decide how granular you want to be in persisting `/home`:
* You could persist all of `/home`. Cruft will accumulate in `~` and `.config` but you may be OK with that. This can be done by persisting home in the NixOS impermanence module or by having a separate subvolume for `/home` that doesn't get wiped at all.
* You could persist the main folders, like user data folders, `.config`, `.local`, and `.ssh`. This is a good middle ground.
* You could persist individual folders within `.config` and `.local`. You will have to comb through these folders and determine what you want to keep and throw away. Anything managed by home-manager should be declaratively symlinked to `/nix/store` and does not need to be persisted. Some applications spew a lot of loose files and folders in `.config` (looking at you, KDE), so this can be a bit fussy. If you have a lot application churn, you'll have to tweak this frequently. But the more you configure your system with home-manager, the less you will need to persist within `.config`.

My recommendation is to begin by persisting everything and gradually fine-tune it if you want. If something breaks, those files still exist in `/persist` and can be easily restored. If you're not sure where an application is storing its config or data, I include a `fs-diff` script which recursively lists all files in a directory, ignoring bind mounts and symlinks. By storing the output of this script in a file before and after making the change you're interested in, you can run a `diff` on those two files and see where that application is writing its change. I've found this especially useful for window manager files.

NB: If you are using the home-manager impermanence module, and intend to persist `~/.config/systemd` (or all of `~/.config`), do it through the **system** impermanence config, not home-manager. The bind mounts made by impermanence are done using systemd, which themselves live in `~/.config/systemd` for home-manager services. Home-manager will fail if you try to do this using its impermanence module. You probably don't need to persist `~/.config/systemd` itself though since its contents should be in your config.

## Hyprland

My hyprland config is pretty simple but I'm happy with how it so far. Nix and the hypr ecosystem complement each other very well. It works great with stylix too.

## Custom options
Several custom options are defined in `vars/default.nix`. These are used to set several system-, user-, or service-related options in each system's or user's config files. This allows shared modules to be tailored to each system/user without rewriting the whole module. Here are a few use cases:
* Use a common `disko` config but vary the swap file size based on `systemOpts.swapSize` (or disable swap entirely with `systemOpts.swapEnable`)
* Use a common `packages.nix` to load packages on all system, but exclude gui apps based on `systemOpts.gui`.
* Use a common `stylix.nix` module for system-wide theming, but each user can set their own `userOpts.theme`, `userOpts.cursor`, and `userOpts.font`.

## Themes

Theming is handled by [Stylix](https://nix-community.github.io/stylix/), a nixos module that applies system-wide colors, fonts, icons, cursors, and wallpapers. My stylix config is defined in `hosts/common/core/stylix.nix`.

`themes` contains subfolders for each theme with a wallpaper, polarity file, and scheme file. These are all accessed by stylix based on the theme chosen through `userOpts.theme`. I currently have the following themes:

| Theme Name  | Base16Scheme              |
|-------------|---------------------------|
| everforest  | everforest                |
| gruvbox     | gruvbox-dark-medium       |
| latte       | catppuccin-latte          |
| mocha       | catppuccin-mocha          |
| moon        | tokyo-night-terminal-dark |
| mountain    | catppuccin-latte          |
| nord        | nord                      |
| rainbow-cat | catppuccin-mocha          |
| tokyo       | tokyo-night-terminal-dark |

[Base16Schemes](https://github.com/tinted-theming/schemes?tab=readme-ov-file) are a set of 16 coordinated colors. You can also build your own base16 scheme with stylix if you prefer. You can get scheme names by running `nix run nixpkgs#base16-schemes` and browsing to `result/share/themes`.

## Initial Install
See readme files in each host's subfolder.

## Acknowledgements
* [LibrePhoenix](https://github.com/librephoenix/nixos-config) - Phoenix's videos were a big help in setting up my initial system.
* [Ryan Lin's NixOS and Flakes book](https://nixos-and-flakes.thiscute.world/) - This was probably the single most helpful resource for me in understanding flakes.
* [Emergent Mind](https://github.com/EmergentMind/nix-config) - Helpful videos on SOPS, nixos-anywhere, and yubikey configs. I modeled the structure of my config after his and have borrowed several of his modules.
* [Vim Joyer](https://github.com/vimjoyer/) - Tons of videos on setting up a NixOS system, like impermanence, secrets, stylix, gaming...the list goes on!
* [TheMaxMur's config](https://github.com/TheMaxMur/NixOS-Configuration) - Great documentation and contains a lot of features I borrowed from, like disko and lanzaboote.
* [NixOS: Everything Everywhere All At Once](https://www.youtube.com/watch?v=CwfKlX3rA6E) - This convinced me to jump down the NixOS rabbit hole.
